import json
from django.core.management.base import BaseCommand
from facturador.models import Organization
from datetime import datetime

class Command(BaseCommand):
    help = 'Imports organizations from a JSON file'

    def handle(self, *args, **kwargs):
        # Replace this with the path to your JSON file if you're loading from a file
        json_data = '''{'page': 1, 'total_pages': 1, 'total_results': 6, 'data': [{'id': '65556b1c2314cc3933ebea0a', 'created_at': '2023-11-16T01:06:36.647Z', 'plan': None, 'is_production_ready': False, 'pending_steps': [{'type': 'legal', 'description': 'Introduce tus datos fiscales'}, {'type': 'certificate', 'description': 'Sube tu Certificado de Sello Digital (CSD)'}], 'logo_url': 'https://storage.googleapis.com/cdn.facturapi.io/organization/ee3b01c7458f001840e1680ca65ba85635661334/logo.jpg', 'timezone': 'America_Mexico_City', 'legal': {'name': 'Borbolla Group', 'legal_name': 'BORBOLLA GROUP', 'tax_id': 'XIA190128J61', 'tax_system': '601', 'address': {'street': '', 'exterior': '', 'interior': '', 'neighborhood': '', 'neighborhood_code': '', 'city': '', 'municipality': '', 'state': '', 'country': 'MEX', 'zip': '06010'}}, 'customization': {'color': '75A4FF', 'next_folio_number': 1, 'next_folio_number_test': 1, 'default_series': {'I': 'F', 'E': 'NC', 'P': 'P', 'N': 'N', 'T': 'T'}, 'pdf_extra': {'codes': True, 'address_codes': True, 'product_key': True, 'round_unit_price': False, 'tax_breakdown': True, 'ieps_breakdown': True}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'has_logo': True}, 'certificate': {'has_certificate': False, 'updated_at': None, 'expires_at': None, 'serial_number': None}, 'fiel': {'has_certificate': False, 'updated_at': None, 'expires_at': None, 'serial_number': None}, 'receipts': {'invoicing_period': 'month', 'periodicity': 'month', 'duration_days': 7, 'next_folio_number': 1, 'next_folio_number_test': 1}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'pending_plan_update': None, 'completion_level': 21, 'roles': ['owner']}, {'id': '64abb04657124fc31ed8e2eb', 'created_at': '2023-07-10T07:16:22.592Z', 'plan': None, 'is_production_ready': True, 'pending_steps': [], 'logo_url': 'https://storage.googleapis.com/cdn.facturapi.io/organization/cf0ba927e0b4ad45721bd447958d0613a3a5c805/logo.jpg', 'domain': 'boxcontainerpark', 'timezone': 'America_Mexico_City', 'legal': {'name': 'OMICRON INGENIERIA Y EQUIPOS', 'legal_name': 'OMICRON INGENIERIA Y EQUIPOS', 'tax_id': 'OIE2011131K0', 'tax_system': '601', 'address': {'street': 'PEREZ TREVIÃ‘O', 'exterior': '142', 'interior': 'A', 'neighborhood': 'CENTRO', 'city': 'SALTILLO', 'municipality': 'SALTILLO', 'state': 'Coahuila de Zaragoza', 'country': 'MEX', 'zip': '25000', 'neighborhood_code': ''}, 'phone': None, 'website': None}, 'customization': {'color': 'F7971E', 'next_folio_number': 66513, 'next_folio_number_test': 59, 'default_series': {'I': 'F', 'E': 'NC', 'P': 'P', 'N': 'N', 'T': 'T'}, 'pdf_extra': {'codes': True, 'product_key': True, 'round_unit_price': False, 'tax_breakdown': True, 'address_codes': True, 'ieps_breakdown': True}, 'self_invoice': {'allowed_cfdi_uses': ['G01', 'G03', 'I01'], 'apply_resico_isr': False}, 'has_logo': True}, 'certificate': {'has_certificate': True, 'updated_at': '2023-07-10T15:27:38.783Z', 'expires_at': '2025-01-27T05:07:32.000Z', 'serial_number': '00001000000506262169'}, 'fiel': {'has_certificate': False, 'updated_at': None, 'expires_at': None, 'serial_number': None}, 'receipts': {'invoicing_period': 'month', 'periodicity': 'month', 'duration_days': 7, 'next_folio_number': 1, 'next_folio_number_test': 5}, 'self_invoice': {'allowed_cfdi_uses': ['G01', 'G03', 'I01'], 'apply_resico_isr': False}, 'pending_plan_update': None, 'completion_level': 31, 'roles': ['owner']}, {'id': '64357ebb84d0212f1fb2076c', 'created_at': '2023-04-11T15:37:31.065Z', 'plan': None, 'is_production_ready': True, 'pending_steps': [], 'logo_url': 'https://storage.googleapis.com/cdn.facturapi.io/organization/d4575890de0c1cb6b3189acdd8a5d05febef35fe/logo.jpg', 'domain': 'bode', 'timezone': 'America_Mexico_City', 'legal': {'name': 'PROYECTOS BODE', 'legal_name': 'PROYECTOS BODE', 'tax_id': 'PBO180817PQ2', 'tax_system': '601', 'address': {'street': 'FERMIN ESPINOZA ARMILLITA', 'exterior': '1000', 'interior': '', 'neighborhood': 'TOPO CHICO', 'city': 'SALTILLO', 'municipality': 'SALTILLO', 'state': 'Coahuila de Zaragoza', 'country': 'MEX', 'zip': '25248', 'neighborhood_code': ''}, 'phone': '8110087616', 'website': None}, 'customization': {'color': '75A4FF', 'next_folio_number': 759091, 'next_folio_number_test': 2, 'default_series': {'I': 'F', 'E': 'NC', 'P': 'P', 'N': 'N', 'T': 'T'}, 'pdf_extra': {'codes': True, 'product_key': True, 'round_unit_price': True, 'tax_breakdown': True, 'address_codes': True, 'ieps_breakdown': True}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'has_logo': True}, 'certificate': {'has_certificate': True, 'updated_at': '2023-04-11T15:58:36.524Z', 'expires_at': '2026-08-24T22:31:27.000Z', 'serial_number': '00001000000514729780'}, 'fiel': {'has_certificate': False, 'updated_at': None, 'expires_at': None, 'serial_number': None}, 'receipts': {'invoicing_period': 'month', 'periodicity': 'month', 'duration_days': 7, 'next_folio_number': 998011, 'next_folio_number_test': 2}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'pending_plan_update': None, 'completion_level': 31, 'roles': ['owner']}, {'id': '604408b654911d002d4f063d', 'created_at': '2021-03-06T22:56:54.411Z', 'plan': None, 'is_production_ready': True, 'pending_steps': [], 'logo_url': 'https://storage.googleapis.com/cdn.facturapi.io/organization/3bcd312e1f7db0599fcea9dcb02ee72bd4cf6b26/logo.jpg', 'timezone': 'America_Mexico_City', 'legal': {'name': 'OMICRON', 'legal_name': 'OMICRON INGENIERIA Y EQUIPOS SAPI DE CV', 'tax_id': 'OIE2011131K0', 'tax_system': '601', 'address': {'street': 'Perez Trevino', 'exterior': '142-a', 'interior': '', 'neighborhood': 'centro', 'city': 'Saltillo', 'municipality': 'Saltillo', 'state': 'Coahuila de Zaragoza', 'country': 'MEX', 'zip': '25000', 'neighborhood_code': ''}, 'phone': '+528110087616', 'website': ''}, 'customization': {'color': 'F99320', 'next_folio_number': 7683, 'next_folio_number_test': 1, 'default_series': {'E': 'NC', 'I': 'F', 'N': 'N', 'P': 'P', 'T': 'T'}, 'pdf_extra': {'codes': True, 'product_key': True, 'round_unit_price': False, 'tax_breakdown': False, 'address_codes': True, 'ieps_breakdown': True}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'has_logo': True}, 'certificate': {'has_certificate': True, 'updated_at': '2021-03-06T23:12:18.131Z', 'expires_at': '2025-01-27T05:07:32.000Z', 'serial_number': '00001000000506262169'}, 'fiel': {'has_certificate': False, 'updated_at': None, 'expires_at': None, 'serial_number': None}, 'receipts': {'invoicing_period': 'month', 'duration_days': 7, 'next_folio_number': 3, 'periodicity': 'month', 'next_folio_number_test': 1}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'pending_plan_update': None, 'completion_level': 31, 'roles': ['owner']}, {'id': '5e73bb8833fb370029a233f9', 'created_at': '2020-03-19T18:35:52.073Z', 'plan': None, 'is_production_ready': True, 'pending_steps': [], 'logo_url': 'https://storage.googleapis.com/cdn.facturapi.io/organization/d61da980dfc9175290fd9db78d37d2ed745b38d8/logo.jpg', 'timezone': 'America_Mexico_City', 'legal': {'name': 'BORBOLLA METROLOGY', 'legal_name': 'BORBOLLA METROLOGY S.A. DE C.V.', 'tax_id': 'BME030613553', 'tax_system': '601', 'address': {'street': 'HIDALGO NORTE', 'exterior': '448', 'interior': '', 'neighborhood': 'Zona Centro', 'city': 'Saltillo', 'municipality': 'Saltillo', 'state': 'Coahuila de Zaragoza', 'country': 'MEX', 'zip': '25000', 'neighborhood_code': ''}, 'phone': '4128868', 'website': 'WWW.BORBOLLAMETROLOGY.COM'}, 'customization': {'color': 'FB863F', 'next_folio_number': 10165, 'next_folio_number_test': 55088, 'default_series': {'E': 'NC', 'I': 'F', 'N': 'N', 'P': 'P', 'T': 'T'}, 'pdf_extra': {'codes': True, 'product_key': True, 'round_unit_price': False, 'tax_breakdown': False, 'address_codes': True, 'ieps_breakdown': True}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'has_logo': True}, 'certificate': {'has_certificate': True, 'updated_at': '2020-12-08T23:27:47.708Z', 'expires_at': '2024-12-04T17:11:55.000Z', 'serial_number': '00001000000505921318'}, 'fiel': {'has_certificate': False, 'updated_at': None, 'expires_at': None, 'serial_number': None}, 'receipts': {'operations_cycle': 'month', 'duration_days': 7, 'next_folio_number': 1, 'periodicity': 'month', 'next_folio_number_test': 5, 'invoicing_period': 'month'}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'pending_plan_update': None, 'completion_level': 31, 'roles': ['owner']}, {'id': '5e5f1f0c4aee605ab94d17b1', 'created_at': '2020-03-04T03:22:52.182Z', 'plan': None, 'is_production_ready': True, 'pending_steps': [], 'logo_url': 'https://storage.googleapis.com/cdn.facturapi.io/organization/121649b2dbf47b6e2901baa655d169b7a0c68094/logo.jpg', 'domain': 'borbolla', 'timezone': 'America_Mexico_City', 'legal': {'name': 'Borbolla Automation Inc', 'legal_name': 'PROYECTOS BODE', 'tax_id': 'PBO180817PQ2', 'tax_system': '601', 'address': {'street': 'FERMIN ESPINOZA ARMILLITA', 'exterior': '1000', 'interior': '', 'neighborhood': 'TOPO CHICO', 'city': 'Saltillo', 'municipality': 'Saltillo', 'state': 'Coahuila de Zaragoza', 'country': 'MEX', 'zip': '25284', 'neighborhood_code': ''}, 'phone': '8110087616', 'website': 'www.borbolla-automation.com'}, 'customization': {'color': '818899', 'next_folio_number': 11429, 'next_folio_number_test': 121, 'default_series': {'E': 'NC', 'I': 'F', 'N': 'N', 'P': 'P', 'T': 'T'}, 'pdf_extra': {'codes': True, 'product_key': True, 'tax_breakdown': False, 'round_unit_price': False, 'address_codes': True, 'ieps_breakdown': True}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'has_logo': True}, 'certificate': {'has_certificate': True, 'updated_at': '2022-08-26T17:25:41.344Z', 'expires_at': '2026-08-24T22:31:27.000Z', 'serial_number': '00001000000514729780'}, 'fiel': {'has_certificate': False, 'updated_at': None, 'expires_at': None, 'serial_number': None}, 'receipts': {'invoicing_period': 'month', 'periodicity': 'month', 'duration_days': 7, 'next_folio_number': 111007, 'next_folio_number_test': 1}, 'self_invoice': {'allowed_cfdi_uses': [], 'apply_resico_isr': False}, 'pending_plan_update': None, 'completion_level': 31, 'roles': ['owner']}]}'''

        # Load the JSON data
        data = json.loads(json_data)

        # Loop through the organizations and create or update the records
        for org_data in data['data']:
            legal_data = org_data['legal']
            address_data = legal_data['address']

            organization, created = Organization.objects.update_or_create(
                organization_id=org_data['id'],
                defaults={
                    'name': legal_data['name'],
                    'legal_name': legal_data['legal_name'],
                    'tax_id': legal_data['tax_id'],
                    'tax_system': legal_data['tax_system'],
                    'website': legal_data.get('website', ''),
                    'phone': legal_data.get('phone', ''),
                    'street': address_data.get('street', ''),
                    'exterior': address_data.get('exterior', ''),
                    'interior': address_data.get('interior', ''),
                    'neighborhood': address_data.get('neighborhood', ''),
                    'city': address_data.get('city', ''),
                    'municipality': address_data.get('municipality', ''),
                    'state': address_data.get('state', ''),
                    'country': address_data.get('country', ''),
                    'zip_code': address_data.get('zip', ''),
                    'is_production_ready': org_data['is_production_ready'],
                    'pending_steps': org_data.get('pending_steps', []),
                    'has_logo': org_data['customization'].get('has_logo', False),
                    'color': org_data['customization'].get('color', ''),
                    'next_folio_number': org_data['customization'].get('next_folio_number', 1),
                    'next_folio_number_test': org_data['customization'].get('next_folio_number_test', 1),
                    'certificate_expires_at': org_data['certificate'].get('expires_at', None),
                    'certificate_updated_at': org_data['certificate'].get('updated_at', None),
                    'created_at': org_data['created_at'],
                }
            )

            if created:
                self.stdout.write(self.style.SUCCESS(f'Organization {organization.legal_name} created successfully.'))
            else:
                self.stdout.write(self.style.SUCCESS(f'Organization {organization.legal_name} updated successfully.'))

